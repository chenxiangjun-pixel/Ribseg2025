# 推理+可视化指南

两个核心组件：
- **infer.py**: 点云肋骨分割推理引擎
- **npy2nii.py**: 结果后处理和医学图像格式转换

## 工作流程

```
输入数据 (.npy点云) 
    ↓
infer.py (PointNet2推理)
    ↓
点云分割结果 (./inference_results/point/, ./inference_results/label/)
    ↓
npy2nii.py (3D重建+后处理)
    ↓
最终输出 (肋骨mask + 中心线骨架)
```

## 1. infer.py - 深度学习推理模块

### 功能说明
- 加载训练好的肋骨分割模型
- 对点云数据进行二分类分割（肋骨 vs 背景）
- 支持批量推理和性能评估


### 数据目录结构
```
data/pn/
├── data_pn/
│   ├── test/
│   │   ├── RibFrac1.npy
│   │   └── RibFrac2.npy
│   └── val/
└── label_pn/  # 可选，用于计算Dice系数
    ├── test/
    └── val/
```

### 使用方法

#### 基本推理
```bash
python infer.py \
    --data_root ./data/pn \
    --split test \
    --output_dir ./inference_results \
    --weights ./log/part_seg/ribseg_experiment/best_model.pth
```

#### 完整参数说明
```bash
python infer.py \
    --device cuda \                    # 设备选择: cuda/cpu/auto
    --num_point 30000 \               # 采样点数量
    --experiment_name ribseg_experiment \  # 实验名称
    --weights /path/to/model.pth \    # 模型权重路径
    --data_root ./data/pn \           # 数据根目录
    --split test \                    # 数据集划分: test/val/train
    --output_dir ./inference_results \ # 输出目录
    --normal_channel \                # 启用normal channel
    --use_attention \                 # 启用注意力机制
    --seed 42 \                      # 随机种子
    --disable_dice                   # 跳过Dice计算
```

### 输出结果
推理完成后会在输出目录生成：
- `point/`: 采样点的原始索引 (.npy)
- `label/`: 分割预测结果 (.npy)

## 2. npy2nii.py - 后处理和格式转换模块

### 功能说明
- 将点云分割结果映射回3D体素空间
- 进行形态学后处理优化分割结果
- 提取肋骨中心线
- 输出标准NIfTI医学图像格式


### 数据目录结构
```
# 输入数据
F:/Data_Collection/Ribfrac/image_test/  # 原始CT数据
├── RibFrac1-image.nii.gz
└── RibFrac2-image.nii.gz

./inference_results/  # infer.py的输出
├── point/
│   ├── RibFrac1.npy
│   └── RibFrac2.npy
└── label/
    ├── RibFrac1.npy
    └── RibFrac2.npy
```

### 配置参数

#### 最优参数配置
```python
OPTIMAL_PARAMS = {
    "dilation_radius": [5, 5, 5],  # 膨胀半径
    "use_closing": True,            # 启用形态学闭运算
    "closing_radius": 3,            # 闭运算半径
    "use_erosion": True,            # 启用腐蚀操作
    "max_ribs": 20,                # 保留的最大肋骨数量
    "fill_holes": True             # 填补空洞
}
```

### 使用方法

#### 1. 修改路径配置
在npy2nii.py中修改以下路径：
```python
source_data_dir = 'F:/Data_Collection/Ribfrac/image_test/'  # 原始CT路径
dis_c2_point_dir = "./inference_results/point/"            # 点数据路径
dis_c2_label_dir = "./inference_results/label/"            # 标签数据路径
output_dir = "./inference_results/nii/"                    # NIfTI输出路径
centreline_dir = "./inference_results/centerline/"         # 中心线输出路径
```

#### 2. 运行后处理
```bash
python npy2nii.py
```

### 输出结果
- `./inference_results/nii/`: 肋骨分割mask (.nii文件)
- `./inference_results/centerline/`: 肋骨中心线 (.nii文件)

## 完整使用流程

### Step 1: 准备数据
1. 将点云数据放置在指定目录结构中
2. 确保模型权重文件可访问
3. 准备原始CT数据

### Step 2: 执行推理
```bash
# 运行深度学习推理
python infer.py \
    --data_root ./data/pn \
    --split test \
    --output_dir ./inference_results \
    --weights ./best_model.pth \
    --use_attention \
    --seed 42
```

### Step 3: 后处理和格式转换
```bash
# 修改npy2nii.py中的路径配置
# 然后运行
python npy2nii.py
```

### Step 4: 结果验证
检查输出文件：
- 分割结果: `./inference_results/nii/RibFrac*-mask.nii`
- 中心线: `./inference_results/centerline/RibFrac*-centraline.nii`

## 性能优化建议

### 内存优化
- 调整`num_point`参数平衡精度和内存使用
- 使用GPU加速推理过程

### 质量优化
- 调整后处理参数优化分割质量
- 根据具体数据集调整`max_ribs`参数

### 批处理优化
- 使用脚本批量处理多个数据集
- 并行处理独立的推理任务

## 常见问题排查

### 1. 模型权重找不到
```bash
# 检查权重文件路径
ls -la log/part_seg/ribseg_experiment/best_model.pth
# 或者使用绝对路径
--weights /absolute/path/to/best_model.pth
```

### 2. CUDA内存不足
```bash
# 减少点云采样数量
--num_point 20000
# 或使用CPU推理
--device cpu
```

### 3. 输出文件命名问题
- 确保原始CT文件名格式一致
- 检查文件名解析逻辑
- 验证输入输出路径权限

如遇到问题，请检查：
1. 依赖库版本兼容性
2. 数据格式和路径配置
3. GPU内存和计算能力
4. 文件权限和磁盘空间

建议在测试环境先用小数据集验证完整流程。